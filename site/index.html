<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Pyodide</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  </head>
  <body>
    <pre id="info">Loading drawing...</pre>
    <div id="visual" style="width: fit-content;"></div>

    <script type="module">
      const info = document.getElementById("info");
      const visual = document.getElementById("visual");

      let pyodide;

      const main = async () => {
        pyodide = await loadPyodide();

        pyodide.registerJsModule("basthon", fakeBasthonPackage)
        await pyodide.loadPackage("./turtle-0.0.1-py3-none-any.whl")
        info.style.display = 'none'

        var code = `import turtle
pen = turtle.Turtle()
pen.write("Hello World")
          `
          await pyodide.runPython(code);
          await showScene();
      };

      const showScene = () => pyodide.runPython(`
        import turtle
        import basthon

        svg_dict = turtle.Screen().show_scene()
        basthon.kernel.display_event({ "display_type": "turtle", "content": svg_dict })
        turtle.restart()
      `);

      const fakeBasthonPackage = {
        kernel: {
          display_event: (e) => visual.innerHTML = elementFromProps(e.toJs().get("content")).outerHTML,
          locals: () => pyodide.runPython("globals()"),
        },
      };

      const elementFromProps = (map) => {
        const tag = map.get("tag");
        if (!tag) { return document.createTextNode(map.get("text")); }

        const node = document.createElement(map.get("tag"));

        for (const [key, value] of map.get("props")) { node.setAttribute(key, value); }
        for (const childProps of map.get("children")) { node.appendChild(elementFromProps(childProps)); }

        return node;
      }

      main();
    </script>
  </body>
</html>
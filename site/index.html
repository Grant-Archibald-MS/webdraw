<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Pyodide</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  </head>
  <body>
    <pre id="info">Loading drawing...</pre>
    <div id="visual" style="width: fit-content;"></div>

    <script type="module">
      const info = document.getElementById("info");
      const visual = document.getElementById("visual");

      let pyodide;

      const main = async () => {
        pyodide = await loadPyodide();

        pyodide.registerJsModule("basthon", fakeBasthonPackage)
        await pyodide.loadPackage("./turtle-0.0.1-py3-none-any.whl")
        info.style.display = 'none'

        var code = `import turtle
pen = turtle.Turtle()
# Draw fastest speed
pen.speed(0)

def draw_filled_triangle(x, y, size, fill_color):
    # Move the pen to the starting position
    pen.penup()
    pen.goto(x, y)
    pen.pendown()
    
    # Set the fill color
    pen.fillcolor(fill_color)
    
    # Start filling the shape
    pen.begin_fill()
    
    # Draw the triangle
    for _ in range(3):
        pen.forward(size)
        pen.left(120)
    
    # End filling the shape
    pen.end_fill()

def draw_filled_rectangle(x, y, width, height, fill_color):
    # Move the pen to the starting position
    pen.penup()
    pen.goto(x, y)
    pen.pendown()
    
    # Set the fill color
    pen.fillcolor(fill_color)
    
    # Start filling the shape
    pen.begin_fill()
    
    # Draw the rectangle
    for _ in range(2):
        pen.forward(width)
        pen.left(90)
        pen.forward(height)
        pen.left(90)
    
    # End filling the shape
    pen.end_fill()

def draw_text(x, y, text, font_size):
    # Move the pen to the starting position
    pen.penup()
    pen.goto(x, y)
    pen.pendown()
    
    # Draw the text
    pen.write(text, align="center", font=("Arial", font_size, "normal"))

draw_filled_triangle(0, 0, 100, "blue")
draw_filled_rectangle(-150, -50, 200, 100, "red")
draw_text(-50, -160, "This is a red rectangle", 24)

pen.hideturtle()
          `
          await pyodide.runPython(code);
          await showScene();
      };

      const showScene = () => pyodide.runPython(`
        import turtle
        import basthon

        svg_dict = turtle.Screen().show_scene()
        basthon.kernel.display_event({ "display_type": "turtle", "content": svg_dict })
        turtle.restart()
      `);

      const fakeBasthonPackage = {
        kernel: {
          display_event: (e) => visual.innerHTML = elementFromProps(e.toJs().get("content")).outerHTML,
          locals: () => pyodide.runPython("globals()"),
        },
      };

      const elementFromProps = (map) => {
        const tag = map.get("tag");
        if (!tag) { return document.createTextNode(map.get("text")); }

        const node = document.createElement(map.get("tag"));

        for (const [key, value] of map.get("props")) { node.setAttribute(key, value); }
        for (const childProps of map.get("children")) { node.appendChild(elementFromProps(childProps)); }

        return node;
      }

      main();
    </script>
  </body>
</html>